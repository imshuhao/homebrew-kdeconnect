name: Update KDE Connect Formula

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  workflow_dispatch:  # Allow manual triggering

# These permissions are needed for the GitHub token
permissions:
  contents: write
  pull-requests: write

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get current date
        id: date
        run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get install -y curl jq
          
          # Install GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Update formula
        run: |
          # Get latest ARM64 build URL
          ARM64_URL=$(curl -s https://cdn.kde.org/ci-builds/network/kdeconnect-kde/master/macos-arm64/ | grep -o 'href="[^"]*\.dmg"' | grep -o '"[^"]*"' | tr -d '"' | sort -r | head -1)
          ARM64_FULL_URL="https://cdn.kde.org/ci-builds/network/kdeconnect-kde/master/macos-arm64/$ARM64_URL"
          
          # Get latest x86_64 build URL
          X86_URL=$(curl -s https://cdn.kde.org/ci-builds/network/kdeconnect-kde/master/macos-x86_64/ | grep -o 'href="[^"]*\.dmg"' | grep -o '"[^"]*"' | tr -d '"' | sort -r | head -1)
          X86_FULL_URL="https://cdn.kde.org/ci-builds/network/kdeconnect-kde/master/macos-x86_64/$X86_URL"
          
          # Update URLs in formula
          sed -i "s|url \"https://cdn.kde.org/ci-builds/network/kdeconnect-kde/master/macos-arm64/.*\"|url \"$ARM64_FULL_URL\"|" Formula/kdeconnect.rb
          sed -i "s|url \"https://cdn.kde.org/ci-builds/network/kdeconnect-kde/master/macos-x86_64/.*\"|url \"$X86_FULL_URL\"|" Formula/kdeconnect.rb
          
          # Update version instead of revision to force Homebrew to recognize it as a new version
          NEW_VERSION="0.$(date +%Y%m%d)"
          sed -i "s|version \"[^\"]*\"|version \"$NEW_VERSION\"|" Formula/kdeconnect.rb
          
          echo "ARM64 URL: $ARM64_FULL_URL"
          echo "X86_64 URL: $X86_FULL_URL"
          
          # Verify that the formula is valid
          mkdir -p /tmp/homebrew-test/Library/Taps/testuser
          cp -r . /tmp/homebrew-test/Library/Taps/testuser/homebrew-kdeconnect
          HOMEBREW_LIBRARY_PATH=/usr/local/Homebrew/Library brew ruby -e "require 'formula'; Formula.factory('/tmp/homebrew-test/Library/Taps/testuser/homebrew-kdeconnect/Formula/kdeconnect.rb')" || echo "Formula check failed but continuing anyway"

      # Push changes to a new branch
      - name: Push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git checkout -b update-kdeconnect-${{ env.DATE }}
          git add Formula/kdeconnect.rb
          git commit -m "Update KDE Connect formula to latest nightly build (${{ env.DATE }})"
          git push -f origin update-kdeconnect-${{ env.DATE }}
          
      # Create the PR using the GitHub CLI and enable auto-merge
      - name: Create Pull Request and Auto-merge
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Create the PR
          PR_URL=$(gh pr create \
            --title "Update KDE Connect formula to latest nightly build (${{ env.DATE }})" \
            --body "This automated PR updates the KDE Connect formula to use the latest nightly build.

            - Updated to version 0.$(date +%Y%m%d) to force brew to fetch the latest DMG files
            - Date: ${{ env.DATE }}" \
            --head update-kdeconnect-${{ env.DATE }} \
            --base main)
          
          if [ $? -eq 0 ] && [ -n "$PR_URL" ]; then
            echo "Created PR: $PR_URL"
            
            # Extract PR number from URL
            PR_NUMBER=$(echo $PR_URL | grep -o '[0-9]*$')
            
            if [ -n "$PR_NUMBER" ]; then
              # Enable auto-merge
              gh pr merge $PR_NUMBER --auto --merge
              echo "Auto-merge enabled for PR #$PR_NUMBER"
            else
              echo "Could not extract PR number from URL: $PR_URL"
            fi
          else
            echo "PR creation failed or PR already exists"
          fi